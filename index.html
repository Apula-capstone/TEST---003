<!DOCTYPE html>
<html>
<head>
    <title>APULA FIRE_OS V3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --fire-red: #e21b3c; --fire-orange: #ff9900; --bg: #1a1a1a; }
        body { background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; }
        
        /* Header */
        header { text-align: center; padding-bottom: 20px; border-bottom: 3px solid var(--fire-orange); margin-bottom: 20px; }
        header h1 { font-family: 'Orbitron', sans-serif; font-size: 4rem; color: var(--fire-orange); margin: 0; letter-spacing: 10px; }

        /* Bento Grid */
        .bento { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; height: 70vh; }
        .tile { background: #2a2a2a; border-radius: 20px; padding: 20px; border: 2px solid #444; position: relative; }
        
        /* Camera Selection Styles */
        .cam-options { display: flex; flex-direction: column; gap: 10px; }
        .cam-btn { 
            background: #333; border: 2px solid var(--fire-orange); color: white; 
            padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold;
        }
        .cam-btn:hover { background: var(--fire-orange); color: black; }

        /* Alerts */
        #alert-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--fire-red); z-index: 1000; justify-content: center; align-items: center;
            flex-direction: column; animation: flash 0.3s infinite;
        }
        @keyframes flash { 0% { background: #ff0000; } 50% { background: #990000; } 100% { background: #ff0000; } }
        
        #video-container { grid-column: span 2; grid-row: span 2; background: black; display: flex; align-items: center; justify-content: center;}
        video, img { width: 100%; height: 100%; border-radius: 15px; object-fit: cover; }
    </style>
</head>
<body>

<header><h1>APULA</h1></header>

<div class="bento">
    <div id="video-container" class="tile">
        <video id="v-player" autoplay playsinline></video>
        <img id="mjpeg-player" style="display:none;">
    </div>

    <div class="tile cam-options">
        <h3>CAMERA SOURCE</h3>
        <button class="cam-btn" onclick="setCam('webcam')">LOCAL WEBCAM</button>
        <button class="cam-btn" onclick="setCam('wifi')">WIFI (ESP32-CAM)</button>
        <button class="cam-btn" onclick="setCam('bt')">BLUETOOTH LINK</button>
        <button class="cam-btn" onclick="setCam('rtsp')">RTSP STREAM</button>
    </div>

    <div class="tile" style="background: linear-gradient(to bottom, var(--fire-orange), #d89e00); color: black;">
        <h3>SYSTEM STATUS</h3>
        <p id="serial-status">DISCONNECTED</p>
        <button class="cam-btn" style="background:black; border:none;" onclick="connect()">CONNECT SERIAL</button>
    </div>
</div>

<div id="alert-screen">
    <h1 style="font-size: 8rem; font-family: 'Orbitron';">!!! FIRE !!!</h1>
    <button onclick="stopAlert()" style="padding: 30px 60px; font-size: 2rem; border-radius: 50px; cursor: pointer;">ACKNOWLEDGE & RESET</button>
</div>

<script>
    let audioCtx, osc, gain;

    // --- Audio System ---
    function initPanicAlarm() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        osc = audioCtx.createOscillator();
        gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.value = 0;
        osc.start();
    }

    function startPanic() {
        if(!audioCtx) initPanicAlarm();
        gain.gain.setTargetAtTime(1, audioCtx.currentTime, 0.05);
        // High-intensity oscillation
        let freqLoop = setInterval(() => {
            if(gain.gain.value < 0.1) { clearInterval(freqLoop); return; }
            osc.frequency.exponentialRampToValueAtTime(1500, audioCtx.currentTime + 0.1);
            setTimeout(() => osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1), 150);
        }, 300);
    }

    // --- Camera Logic ---
    function setCam(type) {
        const v = document.getElementById('v-player');
        const m = document.getElementById('mjpeg-player');
        v.style.display = 'none'; m.style.display = 'none';

        if(type === 'webcam') {
            v.style.display = 'block';
            navigator.mediaDevices.getUserMedia({video: true}).then(s => v.srcObject = s);
        } else if(type === 'wifi') {
            const ip = prompt("Enter ESP32-CAM IP (e.g., 192.168.1.50):");
            m.style.display = 'block';
            m.src = `http://${ip}:81/stream`; // Common ESP32 port
        } else {
            alert(type.toUpperCase() + " requires external gateway/adapter.");
        }
    }

    // --- Serial & Alert Logic ---
    async function connect() {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        document.getElementById('serial-status').innerText = "ONLINE";
        const reader = port.readable.getReader();
        while (true) {
            const { value, done } = await reader.read();
            const msg = new TextDecoder().decode(value);
            if(msg.includes("FIRE:ALL")) triggerFullAlert();
        }
    }

    function triggerFullAlert() {
        document.getElementById('alert-screen').style.display = 'flex';
        startPanic();
    }

    function stopAlert() {
        document.getElementById('alert-screen').style.display = 'none';
        if(gain) gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
    }
</script>
</body>
</html>