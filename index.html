<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üî• APULA FIRE_OS V3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --apula-red: #e21b3c;
            --apula-orange: #ff6b35;
            --apula-yellow: #ffbe0b;
            --apula-purple: #8338ec;
            --apula-blue: #3a86ff;
            --apula-bg: #0a0a14;
            --apula-card: #161624;
            --apula-text: #ffffff;
            --apula-glow: rgba(226, 27, 60, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a0a14 0%, #1a1a2e 100%);
            color: var(--apula-text);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .container {
            width: 100%;
            height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* APULA Header */
        .header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(90deg, var(--apula-red) 0%, var(--apula-orange) 100%);
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(226, 27, 60, 0.4);
            position: relative;
            overflow: hidden;
            animation: headerGlow 3s infinite alternate;
        }

        @keyframes headerGlow {
            0% { box-shadow: 0 8px 25px rgba(226, 27, 60, 0.4); }
            100% { box-shadow: 0 8px 35px rgba(226, 27, 60, 0.7); }
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 900;
            background: linear-gradient(45deg, #ffffff, #ffcccc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .version {
            font-family: 'Orbitron', sans-serif;
            color: white;
            font-size: clamp(0.9rem, 2vw, 1.2rem);
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 25px;
            border: 2px solid white;
        }

        /* Main Content - No Scroll */
        .main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Grid System */
        .dashboard-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 15px;
            padding: 5px;
            overflow: hidden;
        }

        .grid-item {
            background: linear-gradient(145deg, var(--apula-card), #0f1530);
            border-radius: 20px;
            padding: 20px;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .grid-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--apula-red), var(--apula-orange));
        }

        /* Camera Feed - Large on all devices */
        #camera-feed {
            grid-column: 1 / span 8;
            grid-row: 1 / span 3;
            border-color: var(--apula-red);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* Zones Container */
        #zones-container {
            grid-column: 9 / span 4;
            grid-row: 1 / span 3;
            border-color: var(--apula-orange);
            padding: 15px;
            overflow-y: auto;
        }

        /* Zones Grid */
        .zones-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            height: 100%;
        }

        .zone-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .zone-card.safe {
            background: linear-gradient(135deg, #1a2e1a, #0f1a0f);
            border-color: #4CAF50;
        }

        .zone-card.fire {
            background: linear-gradient(135deg, var(--apula-red), var(--apula-orange));
            border-color: #ff4444;
            animation: firePulse 0.8s infinite;
        }

        @keyframes firePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px var(--apula-red); }
            50% { transform: scale(1.02); box-shadow: 0 0 25px var(--apula-red); }
        }

        .zone-card.warning {
            background: linear-gradient(135deg, var(--apula-orange), var(--apula-yellow));
            border-color: var(--apula-yellow);
            animation: warningPulse 2s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }

        .zone-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            margin-bottom: 10px;
            color: white;
        }

        .zone-status {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: 900;
            margin: 10px 0;
            padding: 8px 20px;
            border-radius: 25px;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
        }

        .zone-status.safe {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }

        .zone-status.fire {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            animation: textGlow 1s infinite alternate;
        }

        @keyframes textGlow {
            0% { text-shadow: 0 0 5px #ff0000; }
            100% { text-shadow: 0 0 15px #ff0000; }
        }

        .zone-status.warning {
            background: linear-gradient(45deg, var(--apula-orange), var(--apula-yellow));
            color: #000;
        }

        .zone-sensor {
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            color: #ccc;
            margin-top: 10px;
        }

        /* Control Panel */
        #control-panel {
            grid-column: 1 / span 5;
            grid-row: 4 / span 3;
            border-color: var(--apula-purple);
            padding: 15px;
            overflow-y: auto;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .apula-btn {
            font-family: 'Montserrat', sans-serif;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: 900;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 3px solid white;
            touch-action: manipulation;
        }

        .apula-btn:active {
            transform: scale(0.98);
        }

        .connect-btn {
            background: linear-gradient(135deg, var(--apula-blue), #3a86ff);
        }

        .connect-btn.connected {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .suppression-btn {
            background: linear-gradient(135deg, var(--apula-red), var(--apula-orange));
        }

        .suppression-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suppression-btn.active {
            animation: firePulse 0.8s infinite;
        }

        .test-btn {
            background: linear-gradient(135deg, var(--apula-purple), #8338ec);
        }

        /* System Log */
        #system-log {
            grid-column: 6 / span 7;
            grid-row: 4 / span 3;
            border-color: var(--apula-blue);
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .log-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            margin-bottom: 15px;
            color: var(--apula-blue);
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            border: 2px solid var(--apula-orange);
        }

        .log-container div {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--apula-orange);
            animation: logEntry 0.3s ease-out;
        }

        @keyframes logEntry {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Video Container */
        .video-container {
            flex: 1;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 3px solid var(--apula-red);
            min-height: 200px;
        }

        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 0 15px;
        }

        .camera-select {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--apula-purple), #5a1cb9);
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: clamp(0.8rem, 2vw, 1rem);
            cursor: pointer;
            touch-action: manipulation;
        }

        /* Emergency Modal */
        .emergency-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ff0000, var(--apula-orange));
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: emergencyFlash 0.3s infinite;
        }

        @keyframes emergencyFlash {
            0%, 100% { 
                opacity: 1;
                background: linear-gradient(45deg, #ff0000, var(--apula-orange));
            }
            50% { 
                opacity: 0.9;
                background: linear-gradient(45deg, #000000, #ff0000);
            }
        }

        .emergency-content {
            text-align: center;
            width: 90%;
            max-width: 800px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 25px;
            border: 5px solid white;
            box-shadow: 0 0 80px rgba(255, 0, 0, 0.8);
            animation: modalPulse 0.5s infinite alternate;
        }

        @keyframes modalPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        .emergency-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 8vw, 4rem);
            color: white;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        .emergency-zone {
            font-size: clamp(1.5rem, 6vw, 3rem);
            margin: 20px 0;
            color: white;
            font-weight: 900;
            background: linear-gradient(45deg, #ff0000, #ff8800);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .acknowledge-btn {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.2rem, 4vw, 2rem);
            padding: 20px 40px;
            background: linear-gradient(135deg, #000000, #222222);
            color: white;
            border: 4px solid #00ff00;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            touch-action: manipulation;
        }

        .acknowledge-btn:active {
            transform: scale(0.95);
        }

        /* Status Bar */
        .status-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(90deg, var(--apula-red), var(--apula-orange));
            border-radius: 15px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(226, 27, 60, 0.3);
            border: 2px solid white;
        }

        .serial-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            border: 2px solid white;
        }

        .status-dot.connected {
            background: #4CAF50;
            animation: dotPulse 1.5s infinite;
        }

        @keyframes dotPulse {
            0%, 100% { box-shadow: 0 0 5px #4CAF50; }
            50% { box-shadow: 0 0 15px #4CAF50; }
        }

        .system-time {
            font-family: 'Orbitron', sans-serif;
            color: white;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
        }

        /* Mobile Optimization */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(6, 1fr);
                grid-template-rows: repeat(12, 1fr);
                gap: 12px;
            }

            #camera-feed {
                grid-column: 1 / span 6;
                grid-row: 1 / span 5;
            }

            #zones-container {
                grid-column: 1 / span 6;
                grid-row: 6 / span 3;
            }

            #control-panel {
                grid-column: 1 / span 3;
                grid-row: 9 / span 4;
            }

            #system-log {
                grid-column: 4 / span 3;
                grid-row: 9 / span 4;
            }

            .zones-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .zone-card {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 12px 20px;
                margin-bottom: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, 1fr);
                gap: 10px;
            }

            #camera-feed {
                grid-column: 1;
                grid-row: 1 / span 2;
            }

            #zones-container {
                grid-column: 1;
                grid-row: 3;
            }

            #control-panel {
                grid-column: 1;
                grid-row: 4;
            }

            #system-log {
                display: none; /* Hide log on mobile to save space */
            }

            .zones-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .apula-btn {
                padding: 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .header {
                padding: 10px 15px;
            }

            .logo {
                font-size: 1.5rem;
            }

            .version {
                font-size: 0.8rem;
                padding: 5px 10px;
            }

            .zones-grid {
                grid-template-columns: 1fr;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .grid-item {
                padding: 15px;
            }

            .emergency-content {
                padding: 20px;
            }

            .emergency-title {
                font-size: 2rem;
            }

            .acknowledge-btn {
                font-size: 1.2rem;
                padding: 15px 30px;
            }
        }

        /* Landscape Mode */
        @media (max-height: 600px) and (orientation: landscape) {
            .container {
                padding: 8px;
            }

            .header {
                padding: 10px 15px;
                margin-bottom: 10px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(12, 1fr);
                grid-template-rows: repeat(6, 1fr);
                gap: 8px;
            }

            #camera-feed {
                grid-column: 1 / span 7;
                grid-row: 1 / span 6;
            }

            #zones-container {
                grid-column: 8 / span 5;
                grid-row: 1 / span 3;
            }

            #control-panel {
                grid-column: 8 / span 5;
                grid-row: 4 / span 2;
            }

            #system-log {
                display: none;
            }

            .zone-card {
                padding: 10px;
            }

            .apula-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
        }

        /* Prevent text selection */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide scrollbars but keep functionality */
        .hide-scrollbar {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="no-select">
    <div class="container">
        <!-- APULA Header -->
        <div class="header">
            <div class="logo">APULA FIRE_OS</div>
            <div class="version">V3.0</div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="main-content">
            <div class="dashboard-grid">
                <!-- Camera Feed -->
                <div class="grid-item" id="camera-feed">
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(1rem, 2.5vw, 1.2rem); margin-bottom: 10px; color: var(--apula-red);">
                        üìπ LIVE FIRE MONITORING
                    </div>
                    <div class="video-container">
                        <video id="videoFeed" autoplay playsinline muted></video>
                        <div class="camera-controls">
                            <select class="camera-select" id="cameraSource">
                                <option value="webcam">üì± Webcam</option>
                                <option value="test">üì∫ Test Feed</option>
                            </select>
                            <button class="camera-select" id="startCamera">‚ñ∂Ô∏è START</button>
                        </div>
                    </div>
                </div>

                <!-- Zones Container -->
                <div class="grid-item hide-scrollbar" id="zones-container">
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(1rem, 2.5vw, 1.2rem); margin-bottom: 15px; color: var(--apula-orange);">
                        üö® FIRE ZONES
                    </div>
                    <div class="zones-grid">
                        <div class="zone-card safe" id="zoneAlpha">
                            <div class="zone-title">ALPHA ZONE</div>
                            <div class="zone-status safe">SAFE</div>
                            <div class="zone-sensor">Sensor: 0%</div>
                        </div>
                        <div class="zone-card safe" id="zoneBeta">
                            <div class="zone-title">BETA ZONE</div>
                            <div class="zone-status safe">SAFE</div>
                            <div class="zone-sensor">Sensor: 0%</div>
                        </div>
                        <div class="zone-card safe" id="zoneGamma">
                            <div class="zone-title">GAMMA ZONE</div>
                            <div class="zone-status safe">SAFE</div>
                            <div class="zone-sensor">Sensor: 0%</div>
                        </div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="grid-item hide-scrollbar" id="control-panel">
                    <div style="font-family: 'Orbitron', sans-serif; font-size: clamp(1rem, 2.5vw, 1.2rem); margin-bottom: 15px; color: var(--apula-purple);">
                        ‚ö° CONTROLS
                    </div>
                    <div class="controls-grid">
                        <button class="apula-btn connect-btn" id="connectSerial">
                            üîå CONNECT ARDUINO
                        </button>
                        <button class="apula-btn suppression-btn" id="suppressionControl" disabled>
                            üíß SUPPRESSION STANDBY
                        </button>
                        <button class="apula-btn test-btn" id="testSiren">
                            üîî TEST SIREN
                        </button>
                        <button class="apula-btn test-btn" id="testTripleFire">
                            üî• TEST TRIPLE FIRE
                        </button>
                        <div style="margin-top: 10px; color: #ccc; font-size: clamp(0.8rem, 2vw, 0.9rem);">
                            <p>üîπ Status: <span id="suppressionStatus">INACTIVE</span></p>
                            <p>üîπ Serial: <span id="serialStatusText">DISCONNECTED</span></p>
                        </div>
                    </div>
                </div>

                <!-- System Log -->
                <div class="grid-item hide-scrollbar" id="system-log">
                    <div class="log-title">üìä SYSTEM LOG</div>
                    <div class="log-container" id="systemLog">
                        <div>‚öôÔ∏è APULA FIRE_OS V3.0 Online</div>
                        <div>üîå Serial Bridge: Ready</div>
                        <div>üîä Audio Engine: Ready</div>
                        <div>üëÅÔ∏è Monitoring: All zones active</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="serial-status">
                <div class="status-dot" id="serialStatus"></div>
                <span id="statusText">SERIAL: DISCONNECTED</span>
            </div>
            <div class="system-time" id="systemTime">--:--:--</div>
            <div style="font-weight: bold; font-size: clamp(0.8rem, 2vw, 1rem);">
                APULA FIRE MONITORING
            </div>
        </div>
    </div>

    <!-- Emergency Modal -->
    <div class="emergency-modal" id="emergencyModal">
        <div class="emergency-content">
            <div class="emergency-title">üö® MAJOR EMERGENCY! üö®</div>
            <div class="emergency-zone" id="emergencyZone">ALL ZONES COMPROMISED!</div>
            <div style="font-size: clamp(1rem, 3vw, 1.5rem); color: #ffcccc; margin: 20px 0;">
                üî• TRIPLE FIRE DETECTION - MAXIMUM ALERT! üî•
            </div>
            <div style="font-size: clamp(0.9rem, 2.5vw, 1.2rem); color: white; margin-bottom: 20px;">
                ‚ö†Ô∏è Nonstop Audio Alert Active<br>
                ‚ö° All Suppression Systems Engaged<br>
                üöí Emergency Services Notified
            </div>
            <button class="acknowledge-btn" id="acknowledgeEmergency">
                ‚úÖ ACKNOWLEDGE & SILENCE
            </button>
        </div>
    </div>

    <script>
        class ApulaFireSystem {
            constructor() {
                // System state
                this.serialPort = null;
                this.reader = null;
                this.writer = null;
                this.audioContext = null;
                this.oscillator = null;
                this.gainNode = null;
                this.sirenActive = false;
                this.suppressionActive = false;
                this.tripleFireActive = false;
                this.nonstopAudio = false;
                
                // DOM elements
                this.systemLog = document.getElementById('systemLog');
                this.serialStatus = document.getElementById('serialStatus');
                this.serialStatusText = document.getElementById('serialStatusText');
                this.statusText = document.getElementById('statusText');
                this.connectBtn = document.getElementById('connectSerial');
                this.suppressionBtn = document.getElementById('suppressionControl');
                this.suppressionStatus = document.getElementById('suppressionStatus');
                this.emergencyModal = document.getElementById('emergencyModal');
                this.videoFeed = document.getElementById('videoFeed');
                this.cameraSource = document.getElementById('cameraSource');
                this.systemTime = document.getElementById('systemTime');
                
                // Zone elements
                this.zoneElements = {
                    alpha: document.getElementById('zoneAlpha'),
                    beta: document.getElementById('zoneBeta'),
                    gamma: document.getElementById('zoneGamma')
                };

                this.initialize();
            }

            initialize() {
                // Update time every second
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
                
                // Event listeners
                this.connectBtn.addEventListener('click', () => this.toggleSerialConnection());
                this.connectBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.toggleSerialConnection();
                });
                
                document.getElementById('testSiren').addEventListener('click', () => this.testSiren());
                document.getElementById('testSiren').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.testSiren();
                });
                
                document.getElementById('testTripleFire').addEventListener('click', () => this.testTripleFireAlert());
                document.getElementById('testTripleFire').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.testTripleFireAlert();
                });
                
                document.getElementById('acknowledgeEmergency').addEventListener('click', () => this.acknowledgeEmergency());
                document.getElementById('acknowledgeEmergency').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.acknowledgeEmergency();
                });
                
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('startCamera').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startCamera();
                });
                
                this.suppressionBtn.addEventListener('click', () => this.toggleSuppression());
                this.suppressionBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.toggleSuppression();
                });
                
                // Log system initialization
                this.log('‚öôÔ∏è APULA FIRE_OS V3.0 Initialized', 'system');
                this.log('üîß Responsive interface ready', 'system');
                this.log('üëÅÔ∏è Monitoring zones: Alpha, Beta, Gamma', 'monitor');
                
                // Test camera on startup
                setTimeout(() => this.startCamera(), 1000);
            }

            updateTime() {
                const now = new Date();
                this.systemTime.textContent = now.toLocaleTimeString('en-US', {hour12: false});
            }

            log(message, type = 'info') {
                const logEntry = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                
                // Add emoji based on type
                const emojis = {
                    'error': '‚ùå',
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'system': '‚öôÔ∏è',
                    'monitor': 'üëÅÔ∏è',
                    'audio': 'üîä',
                    'fire': 'üî•'
                };
                
                const emoji = emojis[type] || '>';
                logEntry.innerHTML = `${emoji} [${timestamp}] ${message}`;
                
                this.systemLog.appendChild(logEntry);
                this.systemLog.scrollTop = this.systemLog.scrollHeight;
            }

            async toggleSerialConnection() {
                if (this.serialPort) {
                    await this.disconnectSerial();
                } else {
                    await this.connectSerial();
                }
            }

            async connectSerial() {
                try {
                    if (!('serial' in navigator)) {
                        throw new Error('Web Serial API not supported');
                    }

                    this.serialPort = await navigator.serial.requestPort();
                    await this.serialPort.open({ baudRate: 9600 });

                    this.writer = this.serialPort.writable.getWriter();
                    this.reader = this.serialPort.readable.getReader();

                    // Update UI
                    this.serialStatus.classList.add('connected');
                    this.serialStatusText.textContent = 'CONNECTED';
                    this.statusText.textContent = 'SERIAL: CONNECTED';
                    this.connectBtn.textContent = 'üîå DISCONNECT';
                    this.connectBtn.classList.add('connected');
                    this.suppressionBtn.disabled = false;
                    this.suppressionBtn.textContent = 'üíß MANUAL SUPPRESSION';

                    this.log('üîå Serial: Arduino connected', 'success');
                    this.log('üì° Monitoring 3-zone IR sensor array', 'monitor');

                    // Start reading serial data
                    this.readSerialData();

                } catch (error) {
                    this.log(`‚ùå Serial: ${error.message}`, 'error');
                    alert('Please ensure Arduino is connected.');
                }
            }

            async disconnectSerial() {
                if (this.reader) {
                    this.reader.cancel();
                    this.reader = null;
                }
                if (this.writer) {
                    this.writer.releaseLock();
                    this.writer = null;
                }
                if (this.serialPort) {
                    await this.serialPort.close();
                    this.serialPort = null;
                }

                // Update UI
                this.serialStatus.classList.remove('connected');
                this.serialStatusText.textContent = 'DISCONNECTED';
                this.statusText.textContent = 'SERIAL: DISCONNECTED';
                this.connectBtn.textContent = 'üîå CONNECT ARDUINO';
                this.connectBtn.classList.remove('connected');
                this.suppressionBtn.disabled = true;
                this.suppressionBtn.textContent = 'üíß SUPPRESSION STANDBY';

                this.log('üîå Serial: Disconnected', 'warning');
            }

            async readSerialData() {
                try {
                    while (this.reader) {
                        const { value, done } = await this.reader.read();
                        if (done) break;
                        
                        const text = new TextDecoder().decode(value);
                        this.processSerialData(text.trim());
                    }
                } catch (error) {
                    if (error.name !== 'InterruptedError') {
                        this.log(`‚ùå Serial read error: ${error.message}`, 'error');
                    }
                }
            }

            processSerialData(data) {
                this.log(`üì° Serial: ${data}`, 'monitor');

                // Check for TRIPLE FIRE signal
                if (data === 'TRIPLE_FIRE' || data.includes('ALL_ZONES')) {
                    this.activateTripleFireAlert();
                    return;
                }

                // Parse fire detection commands
                if (data.startsWith('FIRE:')) {
                    const zoneNum = parseInt(data.charAt(5));
                    this.handleFireDetection(zoneNum);
                }
                
                // Parse sensor values
                if (data.includes('A:') || data.includes('B:') || data.includes('G:')) {
                    this.updateSensorValues(data);
                }
            }

            handleFireDetection(zoneNum) {
                const zones = ['alpha', 'beta', 'gamma'];
                const zoneNames = ['ALPHA', 'BETA', 'GAMMA'];
                const zone = zones[zoneNum - 1];
                const zoneName = zoneNames[zoneNum - 1];

                if (!zone) return;

                // Update zone to fire status
                this.updateZone(zone, 100);
                
                // Check if all zones are on fire
                if (this.checkAllZonesOnFire() && !this.tripleFireActive) {
                    this.activateTripleFireAlert();
                } else if (!this.tripleFireActive) {
                    this.activateEmergency(zoneName);
                }
            }

            checkAllZonesOnFire() {
                const zones = ['alpha', 'beta', 'gamma'];
                return zones.every(zone => {
                    const element = this.zoneElements[zone];
                    return element.classList.contains('fire');
                });
            }

            activateTripleFireAlert() {
                if (this.tripleFireActive) return;
                
                this.tripleFireActive = true;
                this.nonstopAudio = true;
                
                // Update all zones to fire status
                this.updateZone('alpha', 100);
                this.updateZone('beta', 100);
                this.updateZone('gamma', 100);
                
                // Show emergency modal
                this.emergencyModal.style.display = 'flex';
                
                // Start nonstop audio
                this.startNonstopEmergencySiren();
                this.activateSuppression();
                
                this.log('üî• TRIPLE FIRE DETECTED!', 'fire');
                this.log('üîä NONSTOP AUDIO: Activated', 'audio');
                this.log('üí¶ SUPPRESSION: All systems engaged', 'warning');
            }

            updateSensorValues(data) {
                // Parse sensor values like "A:85 B:10 G:5"
                const parts = data.split(' ');
                parts.forEach(part => {
                    if (part.includes('A:')) {
                        this.updateZone('alpha', parseInt(part.substring(2)));
                    } else if (part.includes('B:')) {
                        this.updateZone('beta', parseInt(part.substring(2)));
                    } else if (part.includes('G:')) {
                        this.updateZone('gamma', parseInt(part.substring(2)));
                    }
                });
                
                // Check for triple fire after updating
                if (this.checkAllZonesOnFire() && !this.tripleFireActive) {
                    this.activateTripleFireAlert();
                }
            }

            updateZone(zone, value) {
                const element = this.zoneElements[zone];
                const status = element.querySelector('.zone-status');
                const sensor = element.querySelector('.zone-sensor');

                sensor.textContent = `Sensor: ${value}%`;

                if (value > 70) {
                    element.className = 'zone-card fire';
                    status.textContent = 'FIRE!';
                    status.className = 'zone-status fire';
                } else if (value > 30) {
                    element.className = 'zone-card warning';
                    status.textContent = 'WARNING';
                    status.className = 'zone-status warning';
                } else {
                    element.className = 'zone-card safe';
                    status.textContent = 'SAFE';
                    status.className = 'zone-status safe';
                }
            }

            testTripleFireAlert() {
                if (this.tripleFireActive) {
                    this.acknowledgeEmergency();
                    return;
                }
                
                this.log('üî• TEST: Simulating triple fire detection', 'warning');
                this.activateTripleFireAlert();
            }

            activateEmergency(zoneName) {
                if (this.tripleFireActive) return;
                
                document.getElementById('emergencyZone').textContent = `${zoneName} ZONE`;
                this.startSiren();
                this.activateSuppression();
                this.log(`üö® EMERGENCY: ${zoneName} zone fire!`, 'error');
            }

            acknowledgeEmergency() {
                this.emergencyModal.style.display = 'none';
                this.tripleFireActive = false;
                this.nonstopAudio = false;
                this.stopSiren();
                this.deactivateSuppression();
                
                // Reset all zones to safe
                Object.keys(this.zoneElements).forEach(zone => {
                    this.updateZone(zone, 0);
                });

                this.log('‚úÖ EMERGENCY: Acknowledged, system reset', 'success');
                this.log('üîä AUDIO: Alarm silenced', 'audio');
            }

            async activateSuppression() {
                if (this.writer && !this.suppressionActive) {
                    try {
                        await this.sendSerialCommand('W1');
                        this.suppressionActive = true;
                        this.suppressionStatus.textContent = 'ACTIVE';
                        this.suppressionBtn.classList.add('active');
                        this.suppressionBtn.textContent = 'üíß DEACTIVATE';
                        this.log('üí¶ SUPPRESSION: Activated', 'success');
                    } catch (error) {
                        this.log(`‚ùå SUPPRESSION: Activation failed`, 'error');
                    }
                }
            }

            async deactivateSuppression() {
                if (this.writer && this.suppressionActive) {
                    try {
                        await this.sendSerialCommand('W0');
                        this.suppressionActive = false;
                        this.suppressionStatus.textContent = 'INACTIVE';
                        this.suppressionBtn.classList.remove('active');
                        this.suppressionBtn.textContent = 'üíß MANUAL SUPPRESSION';
                        this.log('üí¶ SUPPRESSION: Deactivated', 'warning');
                    } catch (error) {
                        this.log(`‚ùå SUPPRESSION: Deactivation failed`, 'error');
                    }
                }
            }

            async toggleSuppression() {
                if (this.suppressionActive) {
                    await this.deactivateSuppression();
                } else {
                    await this.activateSuppression();
                    this.log('üí¶ SUPPRESSION: Manually activated', 'success');
                }
            }

            async sendSerialCommand(command) {
                if (this.writer) {
                    const data = new TextEncoder().encode(command + '\n');
                    await this.writer.write(data);
                    this.log(`üì° Serial TX: ${command}`, 'monitor');
                }
            }

            startNonstopEmergencySiren() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                if (this.sirenActive) {
                    this.stopSiren();
                }
                
                this.oscillator = this.audioContext.createOscillator();
                this.gainNode = this.audioContext.createGain();

                this.oscillator.connect(this.gainNode);
                this.gainNode.connect(this.audioContext.destination);

                // Create intense emergency siren
                this.oscillator.type = 'sawtooth';
                this.oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime);
                
                // Extreme oscillation
                this.oscillator.frequency.exponentialRampToValueAtTime(1400, this.audioContext.currentTime + 0.2);
                this.oscillator.frequency.exponentialRampToValueAtTime(400, this.audioContext.currentTime + 0.4);
                
                // High volume
                this.gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);

                this.oscillator.start();
                this.sirenActive = true;

                // Continue oscillation NONSTOP
                setInterval(() => {
                    if (this.oscillator && this.nonstopAudio) {
                        this.oscillator.frequency.exponentialRampToValueAtTime(1400, this.audioContext.currentTime + 0.2);
                        this.oscillator.frequency.exponentialRampToValueAtTime(400, this.audioContext.currentTime + 0.4);
                    }
                }, 600);
            }

            startSiren() {
                if (this.nonstopAudio) return;
                
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                if (this.sirenActive) return;
                
                this.oscillator = this.audioContext.createOscillator();
                this.gainNode = this.audioContext.createGain();

                this.oscillator.connect(this.gainNode);
                this.gainNode.connect(this.audioContext.destination);

                this.oscillator.type = 'sawtooth';
                this.oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                
                this.oscillator.frequency.exponentialRampToValueAtTime(1200, this.audioContext.currentTime + 0.3);
                this.oscillator.frequency.exponentialRampToValueAtTime(600, this.audioContext.currentTime + 0.6);
                
                this.gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);

                this.oscillator.start();
                this.sirenActive = true;

                // Continue oscillation
                setInterval(() => {
                    if (this.oscillator && this.sirenActive && !this.nonstopAudio) {
                        this.oscillator.frequency.exponentialRampToValueAtTime(1200, this.audioContext.currentTime + 0.3);
                        this.oscillator.frequency.exponentialRampToValueAtTime(600, this.audioContext.currentTime + 0.6);
                    }
                }, 900);
            }

            stopSiren() {
                if (this.oscillator && this.sirenActive) {
                    this.gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.5);
                    setTimeout(() => {
                        this.oscillator.stop();
                        this.oscillator.disconnect();
                        this.sirenActive = false;
                        this.nonstopAudio = false;
                    }, 500);
                }
            }

            testSiren() {
                if (this.sirenActive) {
                    this.stopSiren();
                    this.log('üîä TEST: Siren stopped', 'audio');
                } else {
                    this.startSiren();
                    setTimeout(() => {
                        this.stopSiren();
                    }, 2000);
                    this.log('üîä TEST: 2-second siren test', 'audio');
                }
            }

            async startCamera() {
                const source = this.cameraSource.value;

                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                }

                if (source === 'webcam') {
                    try {
                        this.cameraStream = await navigator.mediaDevices.getUserMedia({
                            video: { 
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                facingMode: { ideal: 'environment' }
                            }
                        });
                        this.videoFeed.srcObject = this.cameraStream;
                        this.log('üìπ CAMERA: Webcam activated', 'success');
                    } catch (error) {
                        this.log(`‚ùå CAMERA: ${error.message}`, 'error');
                        // Fallback to test pattern
                        this.showTestPattern();
                    }
                } else if (source === 'test') {
                    this.showTestPattern();
                }
            }

            showTestPattern() {
                this.videoFeed.srcObject = null;
                // Create a test pattern canvas
                const canvas = document.createElement('canvas');
                canvas.width = 1280;
                canvas.height = 720;
                const ctx = canvas.getContext('2d');
                
                // Draw test pattern
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                gradient.addColorStop(0, 'red');
                gradient.addColorStop(0.5, 'orange');
                gradient.addColorStop(1, 'yellow');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add text
                ctx.fillStyle = 'white';
                ctx.font = '48px Orbitron';
                ctx.textAlign = 'center';
                ctx.fillText('APULA TEST FEED', canvas.width/2, canvas.height/2);
                ctx.font = '24px Montserrat';
                ctx.fillText('Camera feed simulation', canvas.width/2, canvas.height/2 + 40);
                
                // Convert to video stream
                const stream = canvas.captureStream(30);
                this.videoFeed.srcObject = stream;
                this.log('üìπ CAMERA: Test pattern active', 'monitor');
            }
        }

        // Prevent scrolling
        document.addEventListener('touchmove', function(e) {
            if (e.target.type === 'range') return;
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('wheel', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Initialize system when page loads
        window.addEventListener('load', () => {
            const apulaSystem = new ApulaFireSystem();
            window.apula = apulaSystem; // Make available globally for debugging
        });
    </script>
</body>
</html>